<html>

<head></head>

<body></body>

<!-- <script src="http://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha256-k2WSCIexGzOj3Euiig+TlR8gA0EmPjuc79OEeY5L45g="
    crossorigin="anonymous"></script> -->

<style>
    div {
        display: block;
    }
</style>

<script>
    (function () {
        window.nodes = { "": document.body };

        window.on_click = (id) => (event) => {
            var click = { "Click": { "id": id } };
            console.log(JSON.stringify(click));
        };

        window.on_change = (id, element) => (event) => {
            var value = element.value || '';
            var change = { "Change": { "id": id, "value": value } };
            console.log(JSON.stringify(change));
        };

        window.on_command = (cmd) => {
            var cmd = JSON.parse(cmd);

            if (cmd.hasOwnProperty('Create')) {
                var create = cmd['Create'];

                var id = create.id;
                var parent = create.parent;

                var kind = create.kind;
                var value = create.value;

                var attributes = create.attributes;

                var node = kind == 'text' ? document.createTextNode(value) : document.createElement(kind);

                // TODO: could use event-listeners instead of assigning functions?
                // TODO: on_change get some duplicate events
                // TODO: only register for nodes that need to?

                // node.onclick = window.on_click(id);
                // node.onchange = node.onkeypress = node.onpaste = node.oninput = window.on_change(id, node);

                var click = window.on_click(id);
                node.addEventListener("click", click);

                var change = window.on_change(id, node);
                node.addEventListener("change", change);
                node.addEventListener("keypress", change);
                node.addEventListener("input", change);
                // node.addEventListener("cut", change);
                node.addEventListener("paste", change);
                // node.addEventListener("propertychange", change);
                // node.addEventListener("keyup", change);

                for (attr in attributes) {
                    node[attr] = attributes[attr];
                }

                var parent = window.nodes[parent];
                parent.appendChild(node);

                window.nodes[id] = node;
            } else if (cmd.hasOwnProperty('Update')) {
                var update = cmd['Update'];

                var id = update.id;

                var attribute = update.attribute;
                var value = update.value;

                if (attribute == "Text") {
                    window.nodes[id].nodeValue = value;
                } else {
                    // Unsupported attribute!
                }
            } else if (cmd.hasOwnProperty('Remove')) {
                var remove = cmd['Remove'];
                var id = remove.id;

                window.nodes[id].remove();
            }
        };
    })();
</script>

</html>